# svt-hhb3 – Docker‑образ с HHB 3 (бета) для TH1520 / LicheePi 4A

> **Статус:** экспериментальный. Интерфейс HHB 3 β может изменяться.

## 1. Цель проекта

* **Готовая среда** на базе Ubuntu 22.04, содержащая:

  * HHB ≥ 3.0 β — компилятор TVM для CSI‑NN / TH1520.
  * Компилятор Xuantie RISC‑V GCC V2.8 (rv64gcv + xthead\*) для сборки ELF.
  * Полный стек Python/ONNX/TVM и утилиты командной строки.
* **Сопоставление UID/GID** — файлы, созданные в контейнере, принадлежат пользователю хоста.
* **Упрощённый процесс** конвертации и профилирования моделей под LicheePi 4A.

## 2. Структура репозитория

```
.
├── build-docker.sh        # Сборка образа, генерация .env
├── run-docker.sh          # Запуск/подключение к контейнеру
├── docker-compose.yml     # Определение сервиса svt-hhb3
├── Dockerfile             # Рецепт сборки образа
├── .env                   # Автогенерируемый файл с USER_ID и др.
└── data/                  # Локальный каталог, монтируется как /data
```

Доп. скрипты:

* `01-export_to_onnx.py` — экспорт Depth‑Anything V2 в ONNX;
* `03-convert_to_hhb.sh` — конвертация ONNX → HHB.

## 3. Требования

| Требование     | Минимальная версия   | Примечание                  |
| -------------- | -------------------- | --------------------------- |
| Docker Engine  |  23.0                | Buildx / BuildKit включены  |
| Docker Compose | Плагин v2 или v1     | Автодетектируется скриптами |
| ОС хоста       | Linux / macOS / WSL2 | Тестировано на RHEL 9.5    |

## 4. Быстрый старт

```bash
# 1. Клонируем репозиторий
git clone https://github.com/RISCY-SVT/svt-hhb3.git
cd svt-hhb3

# 2. (опц.) задаём версию HHB
echo "HHB_VERSION=3.0.3b0" >> .env

# 3. Собираем образ
./build-docker.sh

# 4. Заходим в контейнер
./run-docker.sh

hhb@container:/data$ hhb --version
HHB version: 3.0.3b0, build 20240512
```

Работать следует в каталоге **/data** (проброшен к `./data` на хосте).

## 5. Типовой сценарий работы

1. **Экспорт модели в ONNX** (если требуется):

   ```bash
   python 01-export_to_onnx.py --checkpoint weights.pth --output depth_anything_v2_vits.onnx
   ```
2. **Конвертация в HHB**:

   ```bash
   bash 03-convert_to_hhb.sh \
        -m depth_anything_v2_vits.onnx \
        -b th1520 \
        --pixel-format BGR --quant int8_asym
   ```
3. Передаём сгенерированные артефакты (`*.hhb`, исходники C) на LicheePi 4A и компилируем.

## 6. Переменные окружения (Docker ARG/ENV)

| Переменная             | Значение по умолчанию                        | Описание                      |
| ---------------------- | -------------------------------------------- | ----------------------------- |
| `HHB_VERSION`          | latest                                       | Устанавливаемый пакет HHB β   |
| `USER_ID` / `GROUP_ID` | UID/GID хоста                                | Автогенерируется скриптом     |
| `TOOLROOT`             | /opt/riscv                                   | Префикс установки компилятора |
| `RISCV_CFLAGS`         | `-march=rv64gcv_zfh_xtheadc -mabi=lp64d -O3` | Пример флагов                 |

## 7. Обновление образа

При изменении Dockerfile или версии HHB перезапустите `./build-docker.sh`.

## 8. Диагностика проблем

| Симптом                        | Возможное решение                              |
| ------------------------------ | ---------------------------------------------- |
| `ModuleNotFoundError: tvm`     | Повторно соберите образ                        |
| `Permission denied` в /data    | Перепроверьте USER\_ID/GROUP\_ID в .env        |
| Медленная загрузка Xuantie GCC | Скачайте архив локально и поправьте Dockerfile |
| Сегфолт HHB                    | Попробуйте другую β‑версию, сообщите баг       |

## 9. Безопасность

* Контейнер запускается **не от root**, а под вашим UID.
* Внутри контейнера `sudo` разрешён без пароля; не монтируйте критичные директории хоста.

## 10. Лицензия

Код в данном репозитории распространяется по лицензии Apache 2.0. Сторонние компоненты сохраняют свои лицензии.

## 11. Благодарности

* [T-Head / Xuantie CSI‑NN](https://github.com/THead-Semi/csi-nn2)
* [HHB (TVM fork)](https://github.com/RISCY-SVT/tvm)
* \[Документация TH1520 NPU]
