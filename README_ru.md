# Среда разработки для RISC-V Xuantie C920

Docker-контейнер для сборки и тестирования библиотеки нейронных сетей [csi-nn2](https://github.com/RISCY-SVT/csi-nn2) с фокусом на процессор RISC-V Xuantie C920 и поддержку RVV 0.7.1.

## Обзор

Проект предоставляет контейнеризованную среду сборки, включающую:
- **Тулчейн RISC-V Xuantie** (GCC V3.1.0 + LLVM V2.1.0)
- **Фреймворк HHB (Heterogeneous Honey Badger)** v3.2.3
- **SHL-Python** v3.2.2
- Преднастроенные флаги сборки для оптимизации под C920
- Инструменты для разработки Python ML/AI

## Требования

- Docker Engine (20.10+)
- Docker Compose (предпочтительно V2, поддерживается V1)
- Хост-система Linux/macOS
- Минимум 10 ГБ свободного места на диске

## Быстрый старт

1. **Клонируйте репозиторий**
   ```bash
   git clone https://github.com/RISCY-SVT/svt-hhb3.git
   cd svt-hhb3
   ```

2. **Соберите Docker-образ**
   ```bash
   ./build-docker.sh
   ```
   Этот скрипт:
   - Автоматически определит ваши user/group ID
   - Обновит `.env` с настройками вашей системы
   - Соберёт Docker-образ со всеми зависимостями
   - Создаст директорию `data/` для постоянного хранения

3. **Запустите контейнер**
   ```bash
   ./run-docker.sh
   ```
   Это запустит контейнер и откроет интерактивную bash-сессию.

## Структура проекта

```
.
├── .env                 # Переменные окружения (генерируется автоматически)
├── build-docker.sh      # Скрипт сборки
├── docker-compose.yml   # Конфигурация Docker Compose
├── Dockerfile          # Определение контейнера
├── run-docker.sh       # Скрипт запуска
└── data/               # Директория для данных (монтируется как /data)
```

## Детали окружения

### Базовая система
- **ОС**: Ubuntu 22.04 LTS
- **Часовой пояс**: Europe/Madrid (настраивается в Dockerfile)
- **Локаль**: en_US.UTF-8 (с поддержкой ru_RU.UTF-8)

### Тулчейн RISC-V
- **GCC**: Xuantie-900 V3.1.0 (Linux 6.6.0, glibc, x86_64)
- **LLVM**: Xuantie-900 V2.1.0 (Linux 6.6.0, glibc, x86_64)
- **Цель**: `riscv64-unknown-linux-gnu`
- **CFLAGS по умолчанию**: `-march=rv64gcv0p7_zfh_xtheadc -mabi=lp64d -O3`

### Инструменты разработки
- Базовые инструменты сборки (gcc, g++, make)
- CMake, Ninja build
- Clang-15, LLVM-15
- Python 3 с pip
- Системы контроля версий (git)
- Редакторы (vim, mc)

### Python-пакеты
Основные библиотеки ML/AI:
- NumPy (<2.0)
- PyTorch и TorchVision
- Экосистема ONNX (onnx, onnxruntime, onnx-simplifier, onnxslim)
- Фреймворк HHB (v3.2.3)
- SHL-Python (v3.2.2)
- Gradio для демонстраций
- Научные вычисления (scipy, matplotlib, sympy)

## Использование

### Базовый рабочий процесс

1. **Поместите исходный код в `data/`**
   ```bash
   cd /data/
   gcrs https://github.com/RISCY-SVT/csi-nn2.git
   ```

2. **Внутри контейнера перейдите к проекту**
   ```bash
   cd /data/csi-nn2
   ```

3. **Соберите с оптимизациями для C920**
   ```bash
   make clean nn2_c920
      ```

### Переменные окружения

Преднастроены в контейнере:
- `CC`: `/opt/riscv/bin/riscv64-unknown-linux-gnu-gcc`
- `CXX`: `/opt/riscv/bin/riscv64-unknown-linux-gnu-g++`
- `CROSS_PREFIX`: `/opt/riscv/bin/riscv64-unknown-linux-gnu`
- `TOOLROOT`: `/opt/riscv`
- `ZSTD_LIB_DIR`: `/usr/lib/x86_64-linux-gnu`

### Флаги сборки для C920

Рекомендуемые флаги сборки для Xuantie C920:
```make
TOOLS_PREFIX = riscv64-unknown-linux-gnu
CFLAGS = -march=rv64gcv0p7_zfh_xtheadc_xtheadvdot -mabi=lp64d -mtune=c920 -fopenmp
```

### Полезные алиасы

Контейнер включает удобные bash-алиасы:
- `ll` - Подробный список файлов
- `gcrs` - Git clone с подмодулями
- `gprs` - Git pull с подмодулями
- `hcg` - Поиск в истории bash
- `7zip` - Архивирование 7z с высокой степенью сжатия
- `path` - Отображение элементов PATH
- `libs` - Отображение элементов LD_LIBRARY_PATH

## Расширенная настройка

### Изменение окружения

1. **Смена версии тулчейна**: Отредактируйте URL в разделе установки тулчейна в Dockerfile
2. **Добавление Python-пакетов**: Измените раздел `pip3 install` в Dockerfile
3. **Изменение часового пояса**: Обновите `ENV TZ=` в Dockerfile
4. **Настройка флагов сборки**: Измените `ENV RISCV_CFLAGS=` в Dockerfile

### Постоянное хранилище

Директория `./data` монтируется как `/data` внутри контейнера. Все файлы, размещённые здесь, сохраняются между перезапусками контейнера.

## Устранение неполадок

### Частые проблемы

1. **Ошибки прав доступа**
   - Скрипт сборки автоматически определяет ваши UID/GID
   - Если проблемы сохраняются, установите вручную в `.env`:
     ```
     USER_ID=1000
     GROUP_ID=1000
     ```

2. **Недостаточно места при сборке**
   ```bash
   docker system prune -a
   ```

3. **Контейнер уже существует**
   ```bash
   docker rm svt-hhb3-310
   ./run-docker.sh
   ```

### Пересборка

Для полной пересборки:
```bash
docker compose down
docker rmi custler/svt-hhb3-310:latest
./build-docker.sh
```

## Технические заметки

### Соображения безопасности
- Контейнер работает от имени обычного пользователя (ваши host UID/GID)
- Sudo-доступ настроен с NOPASSWD для удобства разработки
- Изоляция сети включена по умолчанию

### Оптимизация производительности
- OpenMP включён в CFLAGS по умолчанию
- Поддержка многопоточной сборки (`-j$(nproc)`)
- Оптимизировано для микроархитектуры C920

## Участие в проекте

При внесении вклада в проект:
1. Тестируйте изменения на чистой сборке
2. Документируйте новые зависимости в README
3. Следуйте существующему стилю кода
4. Обновляйте номера версий в `.env` при обновлении инструментов

## Лицензия

Все исходные файлы этого репозитория распространяются под лицензией Apache 2.0. Компоненты сторонних разработчиков сохраняют свои соответствующие лицензии – см. их проекты для подробностей.

## Благодарности

- Тулчейн RISC-V Xuantie от T-Head/Alibaba
- Фреймворк HHB для гетерогенных вычислений
- Библиотека нейронных сетей csi-nn2

---

По вопросам и проблемам создавайте issue на GitHub или обращайтесь к мейнтейнерам.
